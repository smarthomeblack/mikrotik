blueprint:
  name: Camera Snapshot, AI & Notifications to Mobile Color Telegram Speakers More
  description: > 
    # ğŸ“¢ Chá»¥p áº£nh, PhÃ¢n tÃ­ch áº£nh báº±ng AI vÃ  gá»­i ThÃ´ng bÃ¡o náº¿u Cáº£m biáº¿n kÃ­ch hoáº¡t
    
    
    **PhiÃªn báº£n: 1.0**
            
    
      1- **ThÃ´ng bÃ¡o phÃ¢n tÃ­ch hÃ¬nh áº£nh báº±ng AI lÃªn á»©ng dá»¥ng Home Assistant, Telegram vÃ  TTS ra Loa Ä‘Æ°á»£c tÃ­ch há»£p vÃ o Home Assistant ğŸ’¬ğŸ”‰**
    
      2- **CÃ³ thá»ƒ tÃ¹y chá»n gá»­i thÃ´ng bÃ¡o lÃªn nhiá»u Äiá»‡n thoáº¡i, Telegram vÃ  lÃªn nhiá»u Loa Ä‘Æ°á»£c tÃ­nh há»£p trong Home Assistant.**
      
      3- **CÃ³ thá»ƒ thÃªm nhiá»u HÃ nh Ä‘á»™ng tÃ¹y chá»n náº¿u muá»‘n thá»±c hiá»‡n.**
      
      4- **CÃ³ thá»ƒ thÃªm nhiá»u Äiá»u kiá»‡n Ä‘á»ƒ cháº¡y Automation**
      

    <details>
    <summary><b>Tiáº¿n trÃ¬nh:</b> - Nháº¥n Ä‘á»ƒ má»Ÿ rá»™ng</summary>
    
    
      - **Motion sensor:**
        - Chá»n cáº£m biáº¿n muá»‘n kÃ­ch hoáº¡t tá»« danh sÃ¡ch cáº£m biáº¿n Ä‘á»ƒ cháº¡y Automation.
      
      
      - **Camera:**
        - Chá»n camera tá»« danh sÃ¡ch Ä‘á»ƒ chá»¥p áº£nh.
      
      
      - **Location save Snapshots Option (Optional):**
        - Chá»n vá»‹ trÃ­ lÆ°u áº£nh chá»¥p.
        - ThÆ° má»¥c **media** máº·c Ä‘á»‹nh
        - Muá»‘n Ä‘á»•i sang thÆ° má»¥c **www** thÃ¬ chá»n **WWW Folder**
      
      
      - **Mobile App Notify:** Chá»n Ä‘iá»‡n thoáº¡i muá»‘n Ä‘áº©y thÃ´ng bÃ¡o náº¿u muá»‘n. Máº·c Ä‘á»‹nh khÃ´ng Báº­t.
        - **Use The Mobile App Notify Option (Optional):** Chá»n Enable Mobile App Notify Options Ä‘á»ƒ báº­t tÃ­nh nÄƒng thÃ´ng bÃ¡o lÃªn Äiá»‡n thoáº¡i.
        - **Devices Notified:** Chá»n Äiá»‡n thoáº¡i muá»‘n Ä‘áº©y thÃ´ng bÃ¡o lÃªn.
        - **Title:** Nháº­p TiÃªu Ä‘á» cho thÃ´ng bÃ¡o trÃªn Ä‘iá»‡n thoáº¡i.
    
    
      - **Telegram Notifications Settings:** TÃ¹y chá»n cho viá»‡c Ä‘áº©y thÃ´ng bÃ¡o lÃªn Telegram. Máº·c Ä‘á»‹nh Táº¯t.
        - **Use Telegram Notifications Option (Optional):** Chá»n Enable Telegram Notifications Ä‘á»ƒ báº­t tÃ­nh nÄƒng thÃ´ng bÃ¡o lÃªn Telegram.
        - **Telegram Group ID:** Nháº­p Chat ID Telegram. Náº¿u Ä‘áº©y vÃ o Group thÃ¬ nháº­p Topic ID bÃªn dÆ°á»›i.
        - **Telegram Topic ID:** Nháº­p Topic ID náº¿u muá»‘n Ä‘áº©y thÃ´ng bÃ¡o vÃ o Topic cá»§a Group. KhÃ´ng sá»­ dá»¥ng Group thÃ¬ Ä‘á»ƒ trá»‘ng.
      
      
      - **Text-to-Speech Announcement:** Báº­t tÃ­nh nÄƒng thÃ´ng bÃ¡o ná»™i dung ra Loa Ä‘Æ°á»£c tÃ­ch há»£p vÃ o Home Assistant. Máº·c Ä‘á»‹nh khÃ´ng Báº­t.
        - **Use The Text-to-Speech Announcement Option (Optional):** Chá»n Enable Text-to-Speech Announcements Ä‘á»ƒ - **báº­t tÃ­nh nÄƒng thÃ´ng bÃ¡o lÃªn Loa.
        - **Text-to-Speech Service Provider:** Chá»n NgÃ´n ngá»¯.
        - **Media Player:** Nháº­p TiÃªu Ä‘á» cho thÃ´ng bÃ¡o trÃªn Ä‘iá»‡n thoáº¡i.
    
    
      - **Prompt | Number | Delay of Snapshots:** CÃ¡c cÃ i Ä‘áº·t cho AI, Sá»‘ áº£nh cáº§n chá»¥p, Thá»i gian trá»… sau má»—i láº§n chá»¥p.
        - **Number of Snapshots:** KÃ©o Ä‘á»ƒ thiáº¿t láº­p Sá»‘ áº£nh sáº½ chá»¥p Ä‘á»ƒ so sÃ¡nh (tá»« 1 Ä‘áº¿n 5).
        - **Delay after Trigger:** KÃ©o Ä‘á»ƒ thiáº¿t láº­p Thá»i gian trá»… sau khi Triggers vÃ  báº¯t Ä‘áº§u Snapshots (tÃ­nh theo ms).
        - **Delay after Snapshots:** KÃ©o Ä‘á»ƒ thiáº¿t láº­p Thá»i gian trá»… sau má»—i láº§n Snapshots (tÃ­nh theo ms).
        - **AI Prompt:** CÃ¢u lá»‡nh cho AI phÃ¢n tÃ­ch. Báº¡n cÃ³ thá»ƒ thay Ä‘á»•i cÃ¢u lá»‡nh máº·c Ä‘á»‹nh.
      
      
      - **Custom Actions:**
        - **Enable Custom Actions:** Chá»n Enable Custom Actions náº¿u báº¡n muá»‘n thÃªm cÃ¡c HÃ nh Ä‘á»™ng khÃ¡c Ä‘á»ƒ thá»±c hiá»‡n trong Automation.
        - **Custom Actions:** ThÃªm cÃ¡c hÃ nh Ä‘á»™ng tÃ¹y chá»n Ä‘á»ƒ thá»±c hiá»‡n trong Automation.
    
    
      - **Global Conditions:**
        - **Add Condition(s) to run this Automation:** ThÃªm Ä‘iá»u kiá»‡n Ä‘á»ƒ cháº¡y Automation. Automation chá»‰ cháº¡y khi Äiá»u kiá»‡n nÃ y ÄÃºng.
    
    
      - **Is it an iOS device?:**
        - **Is it an iOS device?:** Báº­t náº¿u thiáº¿t bá»‹ muá»‘n thÃ´ng bÃ¡o Mobile App Notify cháº¡y iOS, Máº·c Ä‘á»‹nh lÃ  Android.
    </details>      
    
    
      
    Cáº§n CÃ³ = <b>*</b>
    
    
  domain: automation
  input:

    motion_sensor:
      name: Motion sensor
      description: Chá»n cáº£m biáº¿n Ä‘á»ƒ kÃ­ch hoáº¡t chá»¥p áº£nh.
      selector:
        entity:
          domain: binary_sensor
          device_class: 
            - motion
            - occupancy
            
    camera_device:
      name: Camera
      description: Camera mÃ  báº¡n muá»‘n chá»¥p áº£nh
      selector:
        entity:
          domain: camera
          
    image_path:
      name: Location save Snapshots Option (Optional)
      description: >
        Chá»n vá»‹ trÃ­ sáº½ lÆ°u áº£nh Snapshots
        ThÆ° má»¥c `media` hoáº·c `www (/local/..)` 
      default: media_folder
      selector:
        select:
          options:
            - label: Media Folder
              value: "media_folder"
            - label: WWW Folder
              value: "www_folder"
                    
    device_notify_settings:
      name: "Mobile App Notify"
      icon: mdi:devices
      collapsed: true
      input:
        include_notify:
          name: Use The Mobile App Notify Option (Optional)
          description: >
            Enable náº¿u muá»‘n gá»­i thÃ´ng bÃ¡o lÃªn Ä‘iá»‡n thoáº¡i Ä‘Ã£ chá»n bÃªn dÆ°á»›i.
          default: disable_mobile_app_notify
          selector:
            select:
              options:
                - label: Enable Mobile App Notify Options
                  value: "enable_mobile_app_notify"
                - label: Disable Mobile App Notify Options
                  value: "disable_mobile_app_notify"
          
        is_ios_android:
          name: Is it an Android or iOS device?
          description: >
            Chá»n Ä‘iá»‡n thoáº¡i Ä‘áº©y thÃ´ng bÃ¡o lÃ  Android hay iOS?
          default: android_device
          selector:
            select:
              options:
                - label: Android
                  value: "android_device"
                - label: iOS
                  value: "ios_device"
        notify_device:
          name: Devices Notified
          description: >
            Chá»n Äiá»‡n thoáº¡i muá»‘n thÃ´ng báº£o Ä‘áº©y lÃªn.
          default: []
          selector:
            device:
              filter:
                - integration: mobile_app
              multiple: true
        notify_title:
          name: Title
          description: >
            Nháº­p Title cá»§a ThÃ´ng bÃ¡o.
            CÃ³ tháº» dÃ¹ng CSS HTML Ä‘á»ƒ thiáº¿t láº­p mÃ u sáº¯c, In Ä‘áº­m,... cho ná»™i dung
          default: >
            ğŸ“¢ Nháº­p <b><span style="color: red">TiÃªu Äá»</span></b><i> cho thÃ´ng bÃ¡o á»Ÿ Ä‘Ã¢y</i>{{'\n'}}|-->{{now().strftime('%H:%M:%S %a, %d-%b-%Y')}}
          selector: 
            text:
        status_bar_icon:
          name: "ğŸŒ  Status Bar Icon"
          description: >
            `DÃ nh cho` `Android`
            Thiáº¿t láº­p icon cho thÃ´ng bÃ¡o trÃªn Status Bar Ä‘iá»‡n thoáº¡i
            TÃ¬m icon táº¡i https://pictogrammers.com/library/mdi/
          default: mdi:motion-sensor
          selector:
            icon:
              placeholder: mdi:motion-sensor
        notification_color:
          name: "ğŸ¨ Notification Color"
          description: >
            `DÃ nh cho` `Android`
            Thiáº¿t láº­p mÃ u cho icon thÃ´ng bÃ¡o trÃªn Status Bar Ä‘iá»‡n thoáº¡i
          default: [100, 200, 240]
          selector:
            color_rgb:
         
    telegram_settings:
      name: "Telegram Notifications Settings"
      icon: mdi:message-badge
      collapsed: true
      input:
        include_telegram_notify:
          name: Use Telegram Notifications Option (Optional)
          description: >
            Enable náº¿u muá»‘n gá»­i thÃ´ng bÃ¡o lÃªn Telegram.
          default: disable_telegram_notification
          selector:
            select:
              options:
                - label: Enable Telegram Notifications
                  value: "enable_telegram_notification"
                - label: Disable Telegram Notifications
                  value: "disable_telegram_notification"
        telegram_group_id:
          name: Telegram Group ID
          description: ID cá»§a nhÃ³m Telegram (Ä‘á»ƒ trá»‘ng náº¿u khÃ´ng dÃ¹ng).
          selector:
            text:
          default: ""

        telegram_topic:
          name: Telegram Topic ID
          description: ID cá»§a chá»§ Ä‘á» trong nhÃ³m Telegram (Ä‘á»ƒ trá»‘ng náº¿u khÃ´ng dÃ¹ng).
          selector:
            text:
          default: ""
          
    tts_notify_settings:
      name: "Text-to-Speech Announcement"
      icon: mdi:speaker-message
      collapsed: true
      input:
        include_tts_announcement:
          name: Use The Text-to-Speech Announcement Option (Optional)
          description: >
            Enable khi muá»‘n gá»­i TTS ra loa sáº½ chá»n bÃªn dÆ°á»›i.
          default: disable_tts_announcement
          selector:
            select:
              options:
                - label: Enable Text-to-Speech Announcements
                  value: "enable_tts_announcement"
                - label: Disable Text-to-Speech Announcements
                  value: "disable_tts_announcement"
        text_to_speech_engine:
          name: Text-to-Speech Service Provider
          description: >
            Chá»n dá»‹ch vá»¥ TTS há»— trá»£.
          default: []
          selector:
            entity:
              filter:
                domain: tts
        media_player:
          name: Media Player
          description: >
            Chá»n loa Ä‘á»ƒ phÃ¡t thÃ´ng bÃ¡o
          default: []
          selector:
            entity:
              filter:
                domain: media_player
              multiple: true
 
    prompt_number_delay_settings:
      name: "Prompt | Number | Delay of Snapshots"
      icon: mdi:clock-start
      collapsed: true
      input:
        num_snapshots:
          name: Number of Snapshots
          description: Sá»‘ áº£nh sáº½ chá»¥p Ä‘á»ƒ so sÃ¡nh (tá»« 1 Ä‘áº¿n 5)
          selector:
            number:
              min: 1
              max: 5
              unit_of_measurement: snapshots
          default: 3
        num_delay_actions:
          name: Delay after Trigger
          description: Thá»i gian trá»… sau khi Triggers vÃ  báº¯t Ä‘áº§u Snapshots (tÃ­nh theo ms)
          selector:
            number:
              min: 500
              max: 5000
              step: 500
              unit_of_measurement: ms
          default: 500
        num_delay:
          name: Delay after Snapshots
          description: Thá»i gian trá»… sau má»—i láº§n Snapshots (tÃ­nh theo ms)
          selector:
            number:
              min: 400
              max: 3000
              step: 100
              unit_of_measurement: ms
          default: 500

        ai_prompt:
          name: AI Prompt
          description: CÃ¢u lá»‡nh cho AI phÃ¢n tÃ­ch.
          selector:
            text:
              multiline: true
          default: >
            DÃ¹ng ngÃ´n ngá»¯ Viá»‡t Nam. HÃ£y so sÃ¡nh vÃ  mÃ´ táº£ ráº¥t ngáº¯n gá»n nhá»¯ng gÃ¬ báº¡n tháº¥y trong chuá»—i hÃ¬nh áº£nh
            sau tá»« mÃ¡y áº£nh {{ camera_name }} cá»§a tÃ´i. Náº¿u cÃ³ ngÆ°á»i, Ä‘á»™ng váº­t, xe mÃ¡y
            hoáº·c Ã´ tÃ´, hÃ£y mÃ´ táº£ chi tiáº¿t vá» chÃºng. KhÃ´ng mÃ´ táº£ cÃ¡c váº­t thá»ƒ hoáº·c tÃ²a
            nhÃ  cá»‘ Ä‘á»‹nh. Náº¿u trong chuá»—i áº£nh khÃ´ng cÃ³ ngÆ°á»i hÃ£y tráº£ lá»i "ÄÃ£ phÃ¡t hiá»‡n chuyá»ƒn Ä‘á»™ng tuy nhiÃªn khÃ´ng cÃ³ ngÆ°á»i trong chuá»—i áº£nh khi so sÃ¡nh". Tin nháº¯n cá»§a báº¡n cáº§n Ä‘á»§ ngáº¯n Ä‘á»ƒ cÃ³ thá»ƒ Ä‘Æ°a vÃ o thÃ´ng bÃ¡o trÃªn Ä‘iá»‡n thoáº¡i.
        
    custom_actions_settings:
      name: "Custom Actions"
      icon: mdi:gesture-tap-button
      collapsed: true
      input:
        include_custom_actions:
          name: Use The Custom Action Options (Optional)
          description: >
            Chá»n Enable Custom Actions vÃ  thÃªm Actions bÃªn dÆ°á»›i náº¿u báº¡n muá»‘n thÃªm cÃ¡c HÃ nh Ä‘á»™ng khÃ¡c Ä‘á»ƒ thá»±c hiá»‡n trong Automation nÃ y.
          default: disable_custom_actions
          selector:
            select:
              options:
                - label: Enable Custom Actions
                  value: "enable_custom_actions"
                - label: Disable Custom Actions
                  value: "disable_custom_actions"
        custom_actions:
          name: Custom Actions
          description: >
            ThÃªm báº¥t ká»³ hÃ nh Ä‘á»™ng nÃ o báº¡n muá»‘n cháº¡y trong Automation nÃ y.
            Biáº¿n láº¥y ná»™i dung phÃ¢n tÃ­ch AI cho cÃ¡c ná»™i dung khÃ¡c: `generated_content['text']`
          default: []
          selector:
            action:

    global_conditions_settings:
      name: "Global Conditions"
      icon: mdi:earth
      collapsed: true
      input:
        global_conditions:
          name: Add Condition(s) to run this Automation
          description: >
            ThÃªm Condition Ä‘á»ƒ cháº¡y Automation. Automation chá»‰ cháº¡y khi Conditions nÃ y lÃ  True.
          default: []
          selector:
            condition:

trigger:
  platform: state
  entity_id: !input motion_sensor
  to: 'on'

variables:
  #Device Notify
  include_notify: !input include_notify
  notify_device: !input notify_device
  notify_title: !input notify_title
  filtered_devices: >
    {{ notify_device }}
  
  #Camera
  camera_device: !input camera_device
  camera_name: "{{ state_attr(camera_device, 'friendly_name') }}"
  camera_path: "{{ state_attr(camera_device, 'friendly_name') | lower | replace(' ', '_') }}"
  #Motion Sensor
  motion_sensor: !input motion_sensor
  motion_name: "{{ state_attr(motion_sensor, 'friendly_name') }}"
  #Snapshot
  image_path: !input image_path
  num_delay_actions: !input num_delay_actions
  num_snapshots: !input num_snapshots
  num_delay: !input num_delay
  #AI
  ai_prompt: !input ai_prompt
  #Telegram Message
  include_telegram_notify: !input include_telegram_notify
  telegram_group_id: !input telegram_group_id
  telegram_topic: !input telegram_topic
  #TTS Message
  include_tts_announcement: !input include_tts_announcement
  text_to_speech_engine: !input text_to_speech_engine
  media_player: !input media_player
  #Custom Actions
  include_custom_actions: !input include_custom_actions
  custom_actions: !input custom_actions
  #Global Conditions
  global_conditions: !input global_conditions
  #Iphone
  is_ios_android: !input 'is_ios_android'
  
# All Conditions
condition:
# Global Conditions
  - condition: and
    conditions: !input global_conditions

action:
  - variables:
      snapshot_access_file_path: >
        {% if image_path == 'media_folder' %}
          /media/local/snapshots/{{camera_path}}_snapshot1.jpg
        {% else %}
          /local/snapshots/{{camera_path}}_snapshot1.jpg
        {% endif %}
      snapshot_access_file_path_tele: >
        {% if image_path == 'media_folder' %}
          /media/snapshots/{{camera_path}}_snapshot1.jpg
        {% else %}
          ./www/snapshots/{{camera_path}}_snapshot1.jpg
        {% endif %}
      notification_color: !input "notification_color"
      notification_color_hex: "#{{ '%02x%02x%02x' | format(notification_color[0], notification_color[1], notification_color[2]) }}"
      
  - delay:
      milliseconds: "{{ num_delay_actions }}"
    
  - choose:
      - alias: "Media Folder"
        conditions:
          - "{{ image_path == 'media_folder' }}"
        sequence:
          - repeat:
              count: "{{ num_snapshots }}"
              sequence:
                - service: camera.snapshot
                  data:
                    filename: "/media/snapshots/{{ camera_path }}_snapshot{{ repeat.index }}.jpg"
                  target:
                    entity_id: "{{ camera_device }}"
                - delay:
                    milliseconds: "{{ num_delay }}"
      - alias: "WWW Folder"
        conditions:
          - "{{ image_path == 'www_folder' }}"
        sequence:
          - repeat:
              count: "{{ num_snapshots }}"
              sequence:
                - service: camera.snapshot
                  data:
                    filename: "./www/snapshots/{{ camera_path }}_snapshot{{ repeat.index }}.jpg"
                  target:
                    entity_id: "{{ camera_device }}"
                - delay:
                    milliseconds: "{{ num_delay }}"
  - service: google_generative_ai_conversation.generate_content
    data:
      prompt: "{{ ai_prompt }}"
      filenames: >
        {% set snap_count = num_snapshots %}
        {% set ns = namespace(images=[]) %}
        {% if image_path == 'media_folder'%}
          {% for i in range(1, snap_count + 1) %}
            {% set image = "/media/snapshots/" ~ camera_path ~ "_snapshot" ~ i ~ ".jpg" %} 
            {% set ns.images = ns.images + [image] %}
          {% endfor %}
        {% else %}
          {% for i in range(1, snap_count + 1) %}
            {% set image = "./www/snapshots/" ~ camera_path ~ "_snapshot" ~ i ~ ".jpg" %}
            {% set ns.images = ns.images + [image] %}
          {% endfor %}
        {% endif %}
        {{ ns.images }}
    response_variable: generated_content
    
  - choose:
      - alias: "Check if notification is enabled"
        conditions:
          - "{{ include_notify == 'enable_mobile_app_notify' }}"
          - "{{ filtered_devices | length > 0 }}"
        sequence:
          - choose:
            - alias: "Check if Android"
              conditions:
                - "{{ is_ios_android == 'android_device' }}"
              sequence:
              - alias: Send a notification to each device
                repeat:
                  for_each: "{{ filtered_devices }}"
                  sequence:
                    - action: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                      data:
                        title: !input notify_title
                        message: "{{ generated_content['text'] }}"
                        data:
                          priority: high
                          notification_icon: !input status_bar_icon
                          color: "{{ notification_color_hex }}"
                          image: "{{snapshot_access_file_path}}"
            - alias: "Check if iOS"
              conditions:
                - "{{ is_ios_android == 'ios_device' }}"
              sequence:
              - action: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                data:
                  title: !input notify_title
                  message: >
                    {{ generated_content['text'] }}
                  data:
                    attachment:
                      url: "{{snapshot_access_file_path}}"
                      content_type: "JPEG"
                      
  - choose:
    - alias: "Check if Telegram Notifications Option is enabled"
      conditions:
        - "{{ include_telegram_notify == 'enable_telegram_notification' }}"
      sequence:
        - service: telegram_bot.send_photo
          data:
            authentication: digest
            target: "{{ telegram_group_id }}"
            message_thread_id: "{{ telegram_topic | int(0) }}"
            file: "{{ snapshot_access_file_path_tele }}"
            caption: >
              ğŸ” Káº¿t quáº£ phÃ¢n tÃ­ch AI ğŸ¤–:
              {{'\n'}}|--> {{now().strftime('%H:%M:%S %a, %d-%b-%Y')}}
              {{'\n'}}{{generated_content['text']}}

  - choose:
    - alias: "Check if tts announcement is enabled"
      conditions:
        - "{{ include_tts_announcement == 'enable_tts_announcement' }}"
      sequence:
        - action: tts.speak
          target:
            entity_id: !input text_to_speech_engine
          data:
            media_player_entity_id: !input media_player
            message: "{{generated_content['text']}}"
             
  - choose:
    - alias: "Perform the custom action"
      conditions:
        - condition: template
          value_template: "{{ 'enable_custom_actions' in include_custom_actions }}"
      sequence: !input custom_actions

mode: single
max_exceeded: silent
